<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Title -->
    <title>Renew Detail</title>

    <!-- Styles -->
    @Styles.Render("~/Content/css")
</head>
<body>

    <div id="wrapper">
        <!-- Header -->
        @Html.Partial("SoftwareHeader")

        <div id="page-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <h3 class="">
                            <i class="fa fa-refresh fa-fw"></i>  Renew Detail <small>Edit detail page</small>
                        </h3>
                        <ol class="breadcrumb">
                            <li>
                                <a href="/Software">Dashboard</a>
                            </li>
                            <li>
                                <a href="/Software/RenewList">Renew List</a>
                            </li>
                            <li class="active">
                                Renew Detail
                            </li>
                        </ol>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading" align="right">
                        <button class="btn btn-primary" id="btnLock" onclick="btnLockOnClick()">
                            <i class="fa fa-lock fa-fw"></i> Lock
                        </button>
                        <button class="btn btn-primary" id="btnUnlock" onclick="btnUnlockOnClick()">
                            <i class="fa fa-unlock fa-fw"></i> Unlock
                        </button>
                        <button class="btn btn-primary" id="btnCashVoucher" onclick="btnCashVoucherOnClick()">
                            <i class="fa fa-print fa-fw"></i> Cash Voucher
                        </button>
                        <button class="btn btn-primary" id="btnApplicantCollectibles" onclick="btnCollectiblesOnClick()">
                            <i class="fa fa-print fa-fw"></i> Collectibles
                        </button>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <form class="form-horizontal">
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Renew Number</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class="form-control requiredLoanApplication" id="loanApplicationNumber" placeholder="Loan Number" />
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Renew Date</label>
                                                <div class="col-sm-8">
                                                    <div id="loanApplicationLoanDate" style="width: 100%;"></div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Maturity Date</label>
                                                <div class="col-sm-8">
                                                    <div id="loanApplicationMaturityDate" style="width: 100%;"></div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Applicant</label>
                                                <div class="col-sm-8">
                                                    <div id="loanApplicationApplicant" style="width: 100%;"></div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Area</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class="form-control" id="loanApplicationApplicantArea" disabled />
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Particulars</label>
                                                <div class="col-sm-8">
                                                    <textarea class="form-control requiredLoanApplication" rows="5" id="loanApplicationParticulars" placeholder="Particulars"></textarea>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Prepared by</label>
                                                <div class="col-sm-8">
                                                    <div id="loanApplicationPreparedBy" style="width: 100%;"></div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <form class="form-horizontal">
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Terms (Payment)</label>
                                                <div class="col-sm-8">
                                                    <div id="cboTerm" style="width: 100%;"></div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">No. of Days</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class="form-control numberField" id="termNoOfDays" placeholder="0.00" disabled />
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">No. of Days Per Pay</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class="form-control numberField" id="termPaymentNoOfDays" placeholder="0.00" disabled />
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p>Created by:</p>
                                                <div style="padding-left: 10px;">
                                                    <i class="fa fa-key fa-fw"></i> <label id="stampCreatedBy">NA</label>
                                                    <br />
                                                    <small><i class="fa fa-calendar fa-fw"></i> &nbsp;<span id="stampCreatedDate">mm/dd/yyyy</span></small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <p>Updated by:</p>
                                                <div style="padding-left: 10px;">
                                                    <i class="fa fa-key fa-fw"></i> <label id="stampUpdatedBy">NA</label>
                                                    <br />
                                                    <small><i class="fa fa-calendar fa-fw"></i> &nbsp;<span id="stampUpdatedDate">mm/dd/yyyy</span></small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <form class="form-horizontal">
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Renew Amount</label>
                                                <div class="col-sm-8">
                                                    <div class="input-group numberField">
                                                        <span class="input-group-addon">&#8369;</span>
                                                        <input type="text" class="form-control numberField requiredLoanApplication" id="loanApplicationPrincipalAmount" placeholder="0.00" />
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <form class="form-horizontal">
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Interest</label>
                                                <div class="col-sm-8">
                                                    <div id="cboInterest" style="width: 100%;"></div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Rate</label>
                                                <div class="col-sm-8">
                                                    <div class="input-group numberField">
                                                        <span class="input-group-addon">%</span>
                                                        <input type="text" class="form-control numberField" id="interestRate" placeholder="0.00" disabled />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Interest Amount</label>
                                                <div class="col-sm-8">
                                                    <div class="input-group numberField">
                                                        <span class="input-group-addon">&#8369;</span>
                                                        <input type="text" class="form-control numberField" id="interestAmount" placeholder="0.00" disabled />
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <form class="form-horizontal">
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Prev. Balance</label>
                                                <div class="col-sm-8">
                                                    <div class="input-group numberField">
                                                        <span class="input-group-addon">&#8369;</span>
                                                        <input type="text" class="form-control numberField" id="previousBalanceAmount" placeholder="0.00" disabled />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Prev. Penalty</label>
                                                <div class="col-sm-8">
                                                    <div class="input-group numberField">
                                                        <span class="input-group-addon">&#8369;</span>
                                                        <input type="text" class="form-control numberField" id="previousPenaltyAmount" placeholder="0.00" disabled />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Deductions</label>
                                                <div class="col-sm-8">
                                                    <div class="input-group numberField">
                                                        <span class="input-group-addon">&#8369;</span>
                                                        <input type="text" class="form-control numberField requiredLoanApplication" id="loanApplicationDeductionAmount" placeholder="0.00" />
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <form class="form-horizontal">
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Net Amount</label>
                                                <div class="col-sm-8">
                                                    <div class="input-group numberField">
                                                        <span class="input-group-addon">&#8369;</span>
                                                        <input type="text" class="form-control numberField requiredLoanApplication" id="loanApplicationTotalNetAmount" placeholder="0.00" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="control-label col-sm-4">Collection Amount</label>
                                                <div class="col-sm-8">
                                                    <div class="input-group numberField">
                                                        <span class="input-group-addon">&#8369;</span>
                                                        <input type="text" class="form-control numberField requiredLoanApplication" id="loanApplicationTotalNetCollectionAmount" placeholder="0.00" />
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br />
                        <ul id="myTab" class="nav nav-tabs">
                            <li class="active">
                                <a href="#loanDeductions" data-toggle="tab" id="loanDeductionsTab">
                                    Deductions
                                </a>
                            </li>
                            <li>
                                <a href="#loanApplicationCollateral" data-toggle="tab" id="loanApplicationCollateralTab">
                                    Collateral
                                </a>
                            </li>
                            <li>
                                <a href="#loanLines" data-toggle="tab" id="loanLinesTab">
                                    Renew Lines - Collection (Auto Generate When Locked)
                                </a>
                            </li>
                            <li>
                                <a href="#loanRenew" data-toggle="tab" id="loanRenewTab">
                                    Loan Renew
                                </a>
                            </li>
                        </ul>
                        <br />
                        <div id="myTabContent" class="tab-content">
                            <div class="tab-pane fade in active" id="loanDeductions">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <table style="width: 100%">
                                            <tr>
                                                <td>
                                                    Deductions
                                                </td>
                                                <td align="right">
                                                    <button class="btn btn-primary btn-sm" id="btnAddLoanApplicationDeduction" onclick="btnAddLoanApplicationDeductionOnclick()">
                                                        <i class="fa fa-plus fa-fw"></i> Add
                                                    </button>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="panel-body">
                                        <div id="loanApplicationDeductionFlexGrid" class="grid"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade in" id="loanApplicationCollateral">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <table style="width: 100%">
                                            <tr>
                                                <td>
                                                    Collateral
                                                </td>
                                                <td align="right">
                                                    <button class="btn btn-primary btn-sm" id="btnAddLoanApplicationCollateral" onclick="btnAddLoanApplicationCollateralOnclick()">
                                                        <i class="fa fa-plus fa-fw"></i> Add
                                                    </button>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="panel-body">
                                        <div id="loanApplicationCollateralFlexGrid" class="grid"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade in" id="loanLines">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        Renew Lines
                                    </div>
                                    <div class="panel-body">
                                        <div id="loanLinesFlexgrid" class="grid"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade in" id="loanRenew">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        Loan Renew
                                    </div>
                                    <div class="panel-body">
                                        <div id="loanRenewFlexgrid" class="grid"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- loan applciation collateral Detail Modal -->
    <div class="modal fade" id="loanApplicationCollateralEditDetailModal" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Loan Applicant's Collateral Detail</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="control-label col-sm-4">Type</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control requiredLoanApplicationCollateral" id="loanApplicationCollateralType" placeholder="Type" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-4">Brand</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control requiredLoanApplicationCollateral" id="loanApplicationCollateralBrand" placeholder="Brand" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-4">Model Number</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control requiredLoanApplicationCollateral" id="loanApplicationCollateralModelNumber" placeholder="Model Number" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-4">Serial Number</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control requiredLoanApplicationCollateral" id="loanApplicationCollateralSerialNumber" placeholder="Serial Number" />
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="btnSaveLoanApplicationCollateral" onclick="btnSaveLoanApplicationCollateralOnclick()"><i class="fa fa-save fa-fw"></i> Save</button>
                    <button class="btn btn-danger" id="btnCloseLoanApplicationCollateral" data-dismiss="modal"><i class="fa fa-close fa-fw"></i> Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- delete confirmation Loan Application Collateral modal -->
    <div class="modal fade" id="deleteConfirmationLoanApplicationCollateralModal" role="dialog">
        <div class="modal-dialog modal-sm">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Delete Collateral</h4>
                </div>
                <div class="modal-body">
                    Are you sure that you want to delete this Applicant's Collateral?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" id="btnConfirmDeleteLoanApplicationCollateral" onclick="btnConfirmDeleteLoanApplicationCollateralOnclick()">Delete</button>
                    <button class="btn btn-default" id="btnCloseDeleteLoanApplicationCollateralModal" data-dismiss="modal">No</button>
                </div>
            </div>
        </div>
    </div>

    <!-- action loan collection modal -->
    <div class="modal fade" id="actionCollectionModal" role="dialog">
        <div class="modal-dialog modal-sm">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Actions</h4>
                </div>
                <div class="modal-body">

                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" id="" data-dismiss="modal"><i class="fa fa-close fa-fw"></i> Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- loan applciation deduction Detail Modal -->
    <div class="modal fade" id="loanApplicationDeductionEditDetailModal" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Loan Deduction Detail</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="control-label col-sm-4">Deduction</label>
                            <div class="col-sm-8">
                                <div id="cboDeduction" style="width: 100%;"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-4">Is Percentage</label>
                            <div class="col-sm-8">
                                <input type="checkbox" id="loanApplicationDeductionIsPercentage" disabled />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-4">Rate</label>
                            <div class="col-sm-8">
                                <div class="input-group numberField">
                                    <span class="input-group-addon">&#8369;</span>
                                    <input type="text" class="form-control numberField requiredPenalties" id="loanApplicationDeductionPercentageRate" placeholder="0.00" disabled />
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-4">Amount</label>
                            <div class="col-sm-8">
                                <div class="input-group numberField">
                                    <span class="input-group-addon">&#8369;</span>
                                    <input type="text" class="form-control numberField requiredPenalties" id="loanApplicationDeductionDeductionAmount" placeholder="0.00" />
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="btnSaveLoanApplicationDeduction" onclick="btnSaveLoanApplicationDeductionOnclick()"><i class="fa fa-save fa-fw"></i> Save</button>
                    <button class="btn btn-danger" id="btnCloseLoanApplicationDeduction" data-dismiss="modal"><i class="fa fa-close fa-fw"></i> Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- delete confirmation Loan Application Deduction modal -->
    <div class="modal fade" id="deleteConfirmationLoanApplicationDeductionModal" role="dialog">
        <div class="modal-dialog modal-sm">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Delete Deduction</h4>
                </div>
                <div class="modal-body">
                    Are you sure that you want to delete this Applicant's Deduction?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" id="btnConfirmDeleteLoanApplicationDeduction" onclick="btnConfirmDeleteLoanApplicationDeductionOnclick()">Delete</button>
                    <button class="btn btn-default" id="btnCloseDeleteLoanApplicationDeductionModal" data-dismiss="modal">No</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    <script type="text/javascript">
        // Global Variables
        var loanApplicationLoanDate;
        var loanApplicationMaturityDate;
        var cboloanApplicationApplicant;
        var cboloanApplicationCollector;
        var cboloanApplicationPreparedBy;
        var loanApplicationCollectionView;
        var loanApplicationsFlexGrid;
        var isLocked = false;
        var loanApplicationId = 0;
        var loanRequirementCollectionView;
        var loanRequirementFlexGrid;
        var expirationDate;
        var cboRequirementName;
        var loanRequirementId = 0;
        var loanApplicationCollateralCollectionView;
        var loanApplicationCollateralFlexGrid;
        var loanApplicationCollateralId = 0;
        var newDate = new Date();
        var loanApplicationLoanDateValue = [newDate.getMonth() + 1, newDate.getDate(), newDate.getFullYear()].join('-');
        var loanApplicationMaturityDateValue = [newDate.getMonth() + 1, newDate.getDate(), newDate.getFullYear()].join('-');
        var cboLoanNumberLogHistory;
        var cboLoanType;
        var cboTerm;
        var cboInterest;

        var loanApplicationDeductionCollectionView;
        var loanApplicationDeductionFlexGrid;
        var cboDeduction;
        var loanDeductionId = 0;

        // create loan Application Loan Date
        function createloanApplicationLoanDate() {
            loanApplicationLoanDate.dispose();
            loanApplicationLoanDate = new wijmo.input.InputDate('#loanApplicationLoanDate', {
                format: 'MM-dd-yyyy',
                value: new Date(loanApplicationLoanDateValue),
                mask: '99-99-9999',
                onValueChanged: function () {
                    var thisDateValue = [this.value.getMonth() + 1, this.value.getDate(), this.value.getFullYear()].join('-');
                    loanApplicationLoanDateValue = thisDateValue;
                }
            });
        }

        // create loan Application Maturity Date
        function createloanApplicationMaturityDate() {
            loanApplicationMaturityDate.dispose();
            loanApplicationMaturityDate = new wijmo.input.InputDate('#loanApplicationMaturityDate', {
                disabled: true,
                format: 'MM-dd-yyyy',
                value: new Date(loanApplicationMaturityDateValue),
                mask: '99-99-9999',
                onValueChanged: function () {
                    var thisDateValue = [this.value.getMonth() + 1, this.value.getDate(), this.value.getFullYear()].join('-');
                    loanApplicationMaturityDateValue = thisDateValue;
                }
            });
        }

        // loan application loan date and maturity date
        function loanApplicationLoanDateRange() {
            loanApplicationLoanDate = new wijmo.input.InputDate('#loanApplicationLoanDate');
            createloanApplicationLoanDate();

            loanApplicationMaturityDateRange();
        }

        function loanApplicationMaturityDateRange() {
            loanApplicationMaturityDate = new wijmo.input.InputDate('#loanApplicationMaturityDate');
            createloanApplicationMaturityDate();

            cboloanApplicationApplicant = new wijmo.input.ComboBox('#loanApplicationApplicant');
            getApplicant();
        }

        // get applicant
        function getApplicant() {
            var applicantArray = new Array();
            $.ajax({
                url: '/api/applicant/list',
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                data: {},
                success: function (applicantResults) {
                    var disabled = true;
                    if (applicantResults.length > 0) {
                        for (i = 0; i < applicantResults.length; i++) {
                            applicantArray.push({
                                Id: applicantResults[i]["Id"],
                                ApplicantFullName: applicantResults[i]["ApplicantFullName"],
                                AreaId: applicantResults[i]["AreaId"],
                                Area: applicantResults[i]["Area"],
                            });
                        }

                        disabled = false;

                        cboTerm = new wijmo.input.ComboBox('#cboTerm');
                        getTerm();
                    } else {
                        cboTerm = new wijmo.input.ComboBox('#cboTerm');
                        getTerm();
                    }

                    cboloanApplicationApplicant.dispose();
                    cboloanApplicationApplicant = new wijmo.input.ComboBox('#loanApplicationApplicant', {
                        disabled: disabled,
                        placeholder: "Select",
                        itemsSource: applicantArray,
                        isEditable: false,
                        required: true,
                        displayMemberPath: "ApplicantFullName",
                        selectedValuePath: "ApplicantFullName",
                        onSelectedIndexChanged: function () {
                            document.getElementById("loanApplicationApplicantArea").value = this.selectedItem["Area"];
                        }
                    });
                }
            });
        }

        // get users
        function getUser() {
            var userArray = new Array();
            $.ajax({
                url: '/api/user/list',
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                data: {},
                success: function (userrResults) {
                    var disabled = true;
                    if (userrResults.length > 0) {
                        for (i = 0; i < userrResults.length; i++) {
                            userArray.push({
                                Id: userrResults[i]["Id"],
                                FullName: userrResults[i]["FullName"],
                            });
                        }

                        disabled = false;
                    }

                    cboloanApplicationPreparedBy.dispose();
                    cboloanApplicationPreparedBy = new wijmo.input.ComboBox('#loanApplicationPreparedBy', {
                        disabled: disabled,
                        placeholder: "Select",
                        itemsSource: userArray,
                        isEditable: false,
                        required: true,
                        displayMemberPath: "FullName",
                        selectedValuePath: "FullName"
                    });

                    getLoanApplicationById();
                }
            });
        }

        // get loan application by id
        function getLoanApplicationById() {
            $.ajax({
                url: '/api/renew/getById/' + getUrlParameter("id"),
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                data: {},
                success: function (loanApplicationResult) {
                    if (loanApplicationResult != null) {
                        document.getElementById("loanApplicationNumber").disabled = true;
                        document.getElementById('loanApplicationDeductionAmount').disabled = true;
                        document.getElementById('loanApplicationTotalNetCollectionAmount').disabled = true;
                        document.getElementById('loanApplicationTotalNetAmount').disabled = true;
                        document.getElementById("loanApplicationNumber").value = loanApplicationResult.LoanNumber;
                        loanApplicationLoanDate.value = new Date(loanApplicationResult.LoanDate);
                        loanApplicationMaturityDate.value = new Date(loanApplicationResult.MaturityDate);
                        cboloanApplicationApplicant.selectedValue = loanApplicationResult.Applicant;
                        document.getElementById("loanApplicationApplicantArea").value = loanApplicationResult.Area;
                        document.getElementById("loanApplicationParticulars").value = loanApplicationResult.Particulars;
                        cboloanApplicationPreparedBy.selectedValue = loanApplicationResult.PreparedByUser;
                        cboTerm.selectedValue = loanApplicationResult.Term;
                        document.getElementById("termNoOfDays").value = loanApplicationResult.TermNoOfDays;
                        document.getElementById("termPaymentNoOfDays").value = loanApplicationResult.TermPaymentNoOfDays;
                        document.getElementById('loanApplicationPrincipalAmount').value = loanApplicationResult.PrincipalAmount.toLocaleString();
                        cboInterest.selectedValue = loanApplicationResult.Interest;
                        document.getElementById('interestRate').value = loanApplicationResult.InterestRate.toLocaleString();
                        document.getElementById('interestAmount').value = loanApplicationResult.InterestAmount.toLocaleString();
                        document.getElementById('previousBalanceAmount').value = loanApplicationResult.PreviousBalanceAmount.toLocaleString();
                        document.getElementById('previousPenaltyAmount').value = loanApplicationResult.PreviousPenaltyAmount.toLocaleString();
                        document.getElementById('loanApplicationDeductionAmount').value = loanApplicationResult.DeductionAmount.toLocaleString();
                        document.getElementById('loanApplicationTotalNetAmount').value = loanApplicationResult.NetAmount.toLocaleString();
                        document.getElementById('loanApplicationTotalNetCollectionAmount').value = loanApplicationResult.NetCollectionAmount.toLocaleString();
                        document.getElementById('stampCreatedBy').innerHTML = loanApplicationResult.CreatedByUser;
                        document.getElementById('stampCreatedDate').innerHTML = loanApplicationResult.CreatedDateTime;
                        document.getElementById('stampUpdatedBy').innerHTML = loanApplicationResult.UpdatedByUser;
                        document.getElementById('stampUpdatedDate').innerHTML = loanApplicationResult.UpdatedDateTime;

                        if (loanApplicationResult.IsLocked == true) {
                            $("#btnLock").prop("disabled", true);

                            setTimeout(function () {
                                loanApplicationLoanDate.disabled = true;
                                loanApplicationMaturityDate.disabled = true;
                            }, 100);

                            cboloanApplicationApplicant.disabled = true;
                            cboloanApplicationPreparedBy.disabled = true;
                            cboTerm.disabled = true;
                            document.getElementById("loanApplicationParticulars").disabled = true;
                            document.getElementById('loanApplicationPrincipalAmount').disabled = true;
                            cboInterest.disabled = true;
                            $("#btnAddLoanApplicationCollateral").prop("disabled", true);
                            $("#btnAddLoanApplicationDeduction").prop("disabled", true);
                            isLocked = true;
                        } else {
                            $("#btnUnlock").prop("disabled", true);
                            $("#btnPrint").prop("disabled", true);
                        }
                    } else {
                        alert("The record you'd requested has no data");
                        window.history.back();
                    }

                    createFlexGridForLoanApplicationDeduction();
                }
            });
        }

        // form input validation
        function inputValidationForLoanApplication() {
            var isValid = true;
            $('.requiredLoanApplication').each(function () {
                if ($.trim($(this).val()) == '') {
                    isValid = false;
                    $(this).css({
                        "border": "1px solid red"
                    });
                } else {
                    $(this).css({
                        "border": "",
                    });
                }
            });

            return isValid;
        }

        // lock loan
        function btnLockOnClick() {
            if (inputValidationForLoanApplication()) {
                var netAmount = parseFloat(document.getElementById('loanApplicationTotalNetCollectionAmount').value);

                if (netAmount != 0) {

                    $("#btnLock").prop("disabled", true);
                    document.getElementById("btnLock").innerHTML = "<i class='fa fa-spinner fa-spin fa-fw'></i> Locking";
                    $("#btnClose").prop("disabled", true);

                    var loanApplicationObject = new Object();
                    loanApplicationObject.LoanDate = loanApplicationLoanDate.value;
                    loanApplicationObject.ApplicantId = cboloanApplicationApplicant.selectedItem["Id"];
                    loanApplicationObject.Particulars = document.getElementById("loanApplicationParticulars").value;
                    loanApplicationObject.PreparedByUserId = cboloanApplicationPreparedBy.selectedItem["Id"];
                    loanApplicationObject.TermId = cboTerm.selectedItem["Id"];
                    loanApplicationObject.TermNoOfDays = document.getElementById("termNoOfDays").value;
                    loanApplicationObject.TermPaymentNoOfDays = document.getElementById("termPaymentNoOfDays").value;
                    loanApplicationObject.PrincipalAmount = document.getElementById('loanApplicationPrincipalAmount').value;
                    loanApplicationObject.InterestId = cboInterest.selectedItem["Id"];
                    loanApplicationObject.InterestRate = document.getElementById("interestRate").value;
                    loanApplicationObject.InterestAmount = document.getElementById("interestAmount").value;
                    loanApplicationObject.PreviousBalanceAmount = document.getElementById("previousBalanceAmount").value;
                    loanApplicationObject.PreviousPenaltyAmount = document.getElementById("previousPenaltyAmount").value;
                    loanApplicationObject.NetAmount = document.getElementById('loanApplicationTotalNetAmount').value;
                    loanApplicationObject.NetCollectionAmount = document.getElementById('loanApplicationTotalNetCollectionAmount').value;

                    var loanApplicationData = JSON.stringify(loanApplicationObject);
                    $("#processingModal").modal({
                        "show": true,
                        "backdrop": "static"
                    });

                    $.ajax({
                        type: "PUT",
                        url: '/api/loan/lock/' + getUrlParameter("id"),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: loanApplicationData,
                        statusCode: {
                            200: function () {
                                $("#processingModal").modal("hide");
                                toastr.success("Reloading the page", "Lock Successful");
                                window.setTimeout(function () {
                                    location.reload();
                                }, 1500);
                            },
                            404: function () {
                                toastr.error("Not Found");
                                $("#btnLock").prop("disabled", false);
                                document.getElementById("btnLock").innerHTML = "<i class='fa fa-lock fa-fw'></i> Lock";
                                $("#btnClose").prop("disabled", false);
                            },
                            400: function () {
                                toastr.error("Bad Request");
                                $("#btnLock").prop("disabled", false);
                                document.getElementById("btnLock").innerHTML = "<i class='fa fa-lock fa-fw'></i> Lock";
                                $("#btnClose").prop("disabled", false);
                            }
                        }
                    });
                } else {
                    toastr.error("Zero Net Amount");
                }
            } else {
                toastr.error("Invalid Entry");
            }
        }

        // unlock loan
        function btnUnlockOnClick() {
            $("#btnUnlock").prop("disabled", true);
            $("#btnPrint").prop("disabled", true);
            $("#btnClose").prop("disabled", true);
            document.getElementById("btnUnlock").innerHTML = "<i class='fa fa-spinner fa-spin fa-fw'></i> Unlocking";

            $("#processingModal").modal({
                "show": true,
                "backdrop": "static"
            });

            $.ajax({
                type: "PUT",
                url: '/api/loan/unlock/' + getUrlParameter("id"),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                statusCode: {
                    200: function () {
                        $("#processingModal").modal("hide");
                        toastr.success("Reloading the page", "Unlock Successful");
                        window.setTimeout(function () {
                            location.reload();
                        }, 1500);
                    },
                    404: function (message) {
                        $("#processingModal").modal("hide");
                        toastr.error(message.responseText.replace(/"/g, ""), "Error 404 - Not Found");
                        $("#btnUnlock").prop("disabled", false);
                        $("#btnPrint").prop("disabled", false);
                        $("#btnClose").prop("disabled", false);
                        document.getElementById("btnUnlock").innerHTML = "<i class='fa fa-unlock fa-fw'></i> Unlock";
                    },
                    400: function (message) {
                        $("#processingModal").modal("hide");
                        toastr.error(message.responseText.replace(/"/g, ""), "Error 400 - Bad Request");
                        $("#btnUnlock").prop("disabled", false);
                        $("#btnPrint").prop("disabled", false);
                        $("#btnClose").prop("disabled", false);
                        document.getElementById("btnUnlock").innerHTML = "<i class='fa fa-unlock fa-fw'></i> Unlock";
                    },
                    500: function (message) {
                        $("#processingModal").modal("hide");
                        toastr.error(message.responseText.replace(/"/g, ""), "Error 500 - Internal Server Error");
                        $("#btnUnlock").prop("disabled", false);
                        $("#btnPrint").prop("disabled", false);
                        $("#btnClose").prop("disabled", false);
                        document.getElementById("btnUnlock").innerHTML = "<i class='fa fa-unlock fa-fw'></i> Unlock";
                    }
                }
            });
        }

        // get loan application collateral by loan id
        function getLoanApplicationCollateralByLoanId() {
            var loanApplicationCollateralArray = new wijmo.collections.ObservableArray;
            $.ajax({
                url: '/api/loanCollateral/listByLoanId/' + getUrlParameter("id"),
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                success: function (loanApplicationCollateralResults) {
                    if (loanApplicationCollateralResults.length > 0) {
                        for (i = 0; i < loanApplicationCollateralResults.length; i++) {
                            var btnEditButton = "<button class='btn btn-primary btn-xs btn-block' onclick='btnEditLoanApplicationCollateralOnclick()'><i class='fa fa-edit fa-fw'></i> Edit</button>";
                            var btnDeleteButton = "<button class='btn btn-danger btn-xs btn-block' onclick='btnDeleteLoanApplicationCollateralOnclick()'><i class='fa fa-trash fa-fw'></i> Delete</button>";

                            var canPerformActions = "@ViewData["CanPerformActions"]";
                            if (canPerformActions == 1) {
                                if (isLocked) {
                                    btnEditButton = "<button class='btn btn-primary btn-xs btn-block' onclick='btnEditLoanApplicationCollateralOnclick()' disabled><i class='fa fa-edit fa-fw'></i> Edit</button>";
                                    btnDeleteButton = "<button class='btn btn-danger btn-xs btn-block' onclick='btnDeleteLoanApplicationCollateralOnclick()' disabled><i class='fa fa-trash fa-fw'></i> Delete</button>";
                                } else {
                                    btnEditButton = "<button class='btn btn-primary btn-xs btn-block' onclick='btnEditLoanApplicationCollateralOnclick()'><i class='fa fa-edit fa-fw'></i> Edit</button>";
                                    btnDeleteButton = "<button class='btn btn-danger btn-xs btn-block' onclick='btnDeleteLoanApplicationCollateralOnclick()'><i class='fa fa-trash fa-fw'></i> Delete</button>";
                                }
                            } else {
                                btnEditButton = "<button class='btn btn-primary btn-xs btn-block' onclick='btnEditLoanApplicationCollateralOnclick()' disabled><i class='fa fa-edit fa-fw'></i> Edit</button>";
                                btnDeleteButton = "<button class='btn btn-danger btn-xs btn-block' onclick='btnDeleteLoanApplicationCollateralOnclick()' disabled><i class='fa fa-trash fa-fw'></i> Delete</button>";
                            }

                            loanApplicationCollateralArray.push({
                                EditButton: btnEditButton,
                                DeleteButton: btnDeleteButton,
                                Id: loanApplicationCollateralResults[i]["Id"],
                                LoanId: loanApplicationCollateralResults[i]["LoanId"],
                                Type: loanApplicationCollateralResults[i]["Type"],
                                Brand: loanApplicationCollateralResults[i]["Brand"],
                                ModelNumber: loanApplicationCollateralResults[i]["ModelNumber"],
                                SerialNumber: loanApplicationCollateralResults[i]["SerialNumber"]
                            });
                        }
                    }

                    NProgress.done();
                }
            });

            return loanApplicationCollateralArray;
        }

        // edit loan application collateral
        function btnEditLoanApplicationCollateralOnclick() {
            $("#loanApplicationCollateralEditDetailModal").modal({
                "show": true,
                "backdrop": "static"
            });

            $('.requiredLoanApplicationCollateral').each(function () {
                $(this).css({
                    "border": "",
                });
            });

            document.getElementById("btnSaveLoanApplicationCollateral").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
            $("#btnSaveLoanApplicationCollateral").prop("disabled", false);
            $("#btnCloseLoanApplicationCollateral").prop("disabled", false);

            loanApplicationCollateralCollectionView.editItem(loanApplicationCollateralCollectionView.currentItem);
            var currentItem = loanApplicationCollateralCollectionView.currentEditItem;

            loanApplicationCollateralId = currentItem.Id;
            document.getElementById('loanApplicationCollateralType').value = currentItem.Type;
            document.getElementById('loanApplicationCollateralBrand').value = currentItem.Brand;
            document.getElementById('loanApplicationCollateralModelNumber').value = currentItem.ModelNumber;
            document.getElementById('loanApplicationCollateralSerialNumber').value = currentItem.SerialNumber;
        }

        // add loan application ollateral
        function btnAddLoanApplicationCollateralOnclick() {
            $("#loanApplicationCollateralEditDetailModal").modal({
                "show": true,
                "backdrop": "static"
            });

            $('.requiredLoanApplicationCollateral').each(function () {
                $(this).css({
                    "border": "",
                });
            });

            document.getElementById("btnSaveLoanApplicationCollateral").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
            $("#btnSaveLoanApplicationCollateral").prop("disabled", false);
            $("#btnCloseLoanApplicationCollateral").prop("disabled", false);

            loanApplicationCollateralId = 0;
            document.getElementById('loanApplicationCollateralType').value = "NA";
            document.getElementById('loanApplicationCollateralBrand').value = "NA";
            document.getElementById('loanApplicationCollateralModelNumber').value = "NA";
            document.getElementById('loanApplicationCollateralSerialNumber').value = "NA";
        }

        // form input validation
        function inputValidationForLoanApplicationCollateral() {
            var isValid = true;
            $('.requiredLoanApplicationCollateral').each(function () {
                if ($.trim($(this).val()) == '') {
                    isValid = false;
                    $(this).css({
                        "border": "1px solid red"
                    });
                } else {
                    $(this).css({
                        "border": "",
                    });
                }
            });

            return isValid;
        }

        // save loan collateral
        function btnSaveLoanApplicationCollateralOnclick() {
            if (inputValidationForLoanApplicationCollateral()) {
                document.getElementById("btnSaveLoanApplicationCollateral").innerHTML = "<i class='fa fa-spinner fa-spin fa-fw'></i> Saving";
                $("#btnSaveLoanApplicationCollateral").prop("disabled", true);
                $("#btnCloseLoanApplicationCollateral").prop("disabled", true);

                var loanApplicationCollateralObject = new Object();
                loanApplicationCollateralObject.LoanId = getUrlParameter("id");
                loanApplicationCollateralObject.Type = document.getElementById('loanApplicationCollateralType').value;
                loanApplicationCollateralObject.Brand = document.getElementById('loanApplicationCollateralBrand').value;
                loanApplicationCollateralObject.ModelNumber = document.getElementById('loanApplicationCollateralModelNumber').value;
                loanApplicationCollateralObject.SerialNumber = document.getElementById('loanApplicationCollateralSerialNumber').value;
                var loanApplicationCollateralData = JSON.stringify(loanApplicationCollateralObject);

                if (loanApplicationCollateralId == 0) {
                    $.ajax({
                        type: "POST",
                        url: '/api/loanCollateral/add',
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: loanApplicationCollateralData,
                        statusCode: {
                            200: function () {
                                toastr.success("Save Successful");

                                $("#loanApplicationCollateralEditDetailModal").modal("hide");

                                loanApplicationCollateralCollectionView = new wijmo.collections.CollectionView(getLoanApplicationCollateralByLoanId());
                                loanApplicationCollateralFlexGrid.itemsSource = loanApplicationCollateralCollectionView;
                                loanApplicationCollateralFlexGrid.trackChanges = true;
                            },
                            404: function () {
                                toastr.error("Record Not Found");

                                $("#loanApplicationCollateralEditDetailModal").modal("hide");

                                document.getElementById("btnSaveLoanApplicationCollateral").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
                                $("#btnSaveLoanApplicationCollateral").prop("disabled", false);
                                $("#btnCloseLoanApplicationCollateral").prop("disabled", false);
                            },
                            400: function () {
                                toastr.error("Bad Request");

                                $("#loanApplicationCollateralEditDetailModal").modal("hide");

                                document.getElementById("btnSaveLoanApplicationCollateral").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
                                $("#btnSaveLoanApplicationCollateral").prop("disabled", false);
                                $("#btnCloseLoanApplicationCollateral").prop("disabled", false);
                            }
                        }
                    });
                } else {
                    $.ajax({
                        type: "PUT",
                        url: '/api/loanCollateral/update/' + loanApplicationCollateralId,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: loanApplicationCollateralData,
                        statusCode: {
                            200: function () {
                                toastr.success("Update Successful");

                                $("#loanApplicationCollateralEditDetailModal").modal("hide");

                                loanApplicationCollateralCollectionView = new wijmo.collections.CollectionView(getLoanApplicationCollateralByLoanId());
                                loanApplicationCollateralFlexGrid.itemsSource = loanApplicationCollateralCollectionView;
                                loanApplicationCollateralFlexGrid.trackChanges = true;
                            },
                            404: function () {
                                toastr.error("Record Not Found");

                                $("#loanApplicationCollateralEditDetailModal").modal("hide");

                                document.getElementById("btnSaveLoanApplicationCollateral").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
                                $("#btnSaveLoanApplicationCollateral").prop("disabled", false);
                                $("#btnCloseLoanApplicationCollateral").prop("disabled", false);
                            },
                            400: function () {
                                toastr.error("Bad Request");

                                $("#loanApplicationCollateralEditDetailModal").modal("hide");

                                document.getElementById("btnSaveLoanApplicationCollateral").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
                                $("#btnSaveLoanApplicationCollateral").prop("disabled", false);
                                $("#btnCloseLoanApplicationCollateral").prop("disabled", false);
                            }
                        }
                    });
                }
            } else {
                toastr.error("Invalid Entry");
            }
        }

        // delete loan application collateral
        function btnDeleteLoanApplicationCollateralOnclick() {
            $("#deleteConfirmationLoanApplicationCollateralModal").modal({
                "show": true,
                "backdrop": "static"
            });

            document.getElementById("btnConfirmDeleteLoanApplicationCollateral").innerHTML = "Delete";
            $("#btnConfirmDeleteLoanApplicationCollateral").prop("disabled", false);
            $("#btnCloseDeleteLoanApplicationCollateralModal").prop("disabled", false);
        }
        function btnConfirmDeleteLoanApplicationCollateralOnclick() {
            document.getElementById("btnConfirmDeleteLoanApplicationCollateral").innerHTML = "<i class='fa fa-spinner fa-spin fa-fw'></i> Deleting";
            $("#btnConfirmDeleteLoanApplicationCollateral").prop("disabled", true);
            $("#btnCloseDeleteLoanApplicationCollateralModal").prop("disabled", true);

            loanApplicationCollateralCollectionView.editItem(loanApplicationCollateralCollectionView.currentItem);
            var currentItem = loanApplicationCollateralCollectionView.currentEditItem;

            $.ajax({
                type: "DELETE",
                url: '/api/loanCollateral/delete/' + currentItem.Id,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                statusCode: {
                    200: function () {
                        toastr.success("Delete Successful");

                        $("#deleteConfirmationLoanApplicationCollateralModal").modal("hide");

                        loanApplicationCollateralCollectionView = new wijmo.collections.CollectionView(getLoanApplicationCollateralByLoanId());
                        loanApplicationCollateralFlexGrid.itemsSource = loanApplicationCollateralCollectionView;
                        loanApplicationCollateralFlexGrid.trackChanges = true;
                    },
                    404: function () {
                        toastr.error("Record Not Found");

                        $("#deleteConfirmationLoanApplicationCollateralModal").modal("hide");

                        document.getElementById("btnConfirmDeleteLoanApplicationCollateral").innerHTML = "Delete";
                        $("#btnConfirmDeleteLoanApplicationCollateral").prop("disabled", false);
                        $("#btnCloseDeleteLoanApplicationCollateralModal").prop("disabled", false);
                    },
                    400: function () {
                        toastr.error("Bad Request");

                        $("#deleteConfirmationLoanApplicationCollateralModal").modal("hide");

                        document.getElementById("btnConfirmDeleteLoanApplicationCollateral").innerHTML = "Delete";
                        $("#btnConfirmDeleteLoanApplicationCollateral").prop("disabled", false);
                        $("#btnCloseDeleteLoanApplicationCollateralModal").prop("disabled", false);
                    }
                }
            });
        }

        // create flexgrid for loan application collateral
        function createFlexGridForLoanApplicationCollateral() {
            loanApplicationCollateralCollectionView = new wijmo.collections.CollectionView(getLoanApplicationCollateralByLoanId());

            loanApplicationCollateralFlexGrid = new wijmo.grid.FlexGrid('#loanApplicationCollateralFlexGrid');
            loanApplicationCollateralFlexGrid.initialize({
                columns: [
                            {
                                "header": "Edit",
                                "binding": "EditButton",
                                "width": 80,
                                "align": "center",
                                "allowResizing": false,
                                "isContentHtml": true
                            },
                            {
                                "header": "Delete",
                                "binding": "DeleteButton",
                                "width": 80,
                                "align": "center",
                                "allowResizing": false,
                                "isContentHtml": true
                            },
                            {
                                "header": "Type",
                                "binding": "Type",
                                "allowSorting": true,
                                "width": "3*",
                            },
                            {
                                "header": "Brand",
                                "binding": "Brand",
                                "allowSorting": true,
                                "width": "3*",
                            },
                            {
                                "header": "Model Number",
                                "binding": "ModelNumber",
                                "allowSorting": true,
                                "width": "2*",
                            },
                            {
                                "header": "Serial Number",
                                "binding": "SerialNumber",
                                "allowSorting": true,
                                "width": "2*",
                            }
                ],
                autoGenerateColumns: false,
                itemsSource: loanApplicationCollateralCollectionView,
                isReadOnly: true,
                autoSizeMode: wijmo.grid.AutoSizeMode.Both,
                allowDragging: wijmo.grid.AllowDragging.None,
                selectionMode: wijmo.grid.SelectionMode.Row
            });

            loanApplicationCollateralFlexGrid.trackChanges = true;
        }

        // Term
        function getTerm() {
            var termArray = new Array();
            $.ajax({
                url: '/api/term/list',
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                data: {},
                success: function (termResults) {
                    var disabled = true;
                    if (termResults.length > 0) {
                        for (i = 0; i < termResults.length; i++) {
                            termArray.push({
                                Id: termResults[i]["Id"],
                                Term: termResults[i]["Term"],
                                NoOfDays: termResults[i]["NoOfDays"],
                                PaymentNoOfDays: termResults[i]["PaymentNoOfDays"],
                            });
                        }

                        disabled = false;

                        cboInterest = new wijmo.input.ComboBox('#cboInterest');
                        getInterest();
                    } else {
                        cboInterest = new wijmo.input.ComboBox('#cboInterest');
                        getInterest();
                    }

                    cboTerm.dispose();
                    cboTerm = new wijmo.input.ComboBox('#cboTerm', {
                        disabled: disabled,
                        placeholder: "Select",
                        itemsSource: termResults,
                        isEditable: false,
                        required: true,
                        displayMemberPath: "Term",
                        selectedValuePath: "Term",
                        onSelectedIndexChanged: function () {
                            document.getElementById("termNoOfDays").value = this.selectedItem["NoOfDays"];
                            document.getElementById("termPaymentNoOfDays").value = this.selectedItem["PaymentNoOfDays"];
                        }
                    });
                }
            });
        }

        // interest
        function getInterest() {
            var interestArray = new Array();
            $.ajax({
                url: '/api/interest/list',
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                data: {},
                success: function (interestResults) {
                    var disabled = true;
                    if (interestResults.length > 0) {
                        for (i = 0; i < interestResults.length; i++) {
                            interestArray.push({
                                Id: interestResults[i]["Id"],
                                Interest: interestResults[i]["Interest"],
                                Rate: interestResults[i]["Rate"],
                            });
                        }

                        disabled = false;

                        cboloanApplicationPreparedBy = new wijmo.input.ComboBox('#loanApplicationPreparedBy');
                        getUser();
                    } else {
                        cboloanApplicationPreparedBy = new wijmo.input.ComboBox('#loanApplicationPreparedBy');
                        getUser();
                    }

                    cboInterest.dispose();
                    cboInterest = new wijmo.input.ComboBox('#cboInterest', {
                        disabled: disabled,
                        placeholder: "Select",
                        itemsSource: interestArray,
                        isEditable: false,
                        required: true,
                        displayMemberPath: "Interest",
                        selectedValuePath: "Interest",
                        onSelectedIndexChanged: function () {
                            document.getElementById("interestRate").value = this.selectedItem["Rate"];
                            computeDeductions();
                        }
                    });
                }
            });
        }

        // get loan application deduction by loan id
        function getLoanApplicationDeductionByLoanId() {
            var loanApplicationDeductionArray = new wijmo.collections.ObservableArray;
            $.ajax({
                url: '/api/loanDeductions/listByLoanId/' + getUrlParameter("id"),
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                success: function (loanApplicationDeductionResults) {
                    var deductionAmount = 0;
                    if (loanApplicationDeductionResults.length > 0) {
                        for (i = 0; i < loanApplicationDeductionResults.length; i++) {
                            var btnEditButton = "<button class='btn btn-primary btn-xs btn-block' onclick='btnEditLoanApplicationDeductionOnclick()'><i class='fa fa-edit fa-fw'></i> Edit</button>";
                            var btnDeleteButton = "<button class='btn btn-danger btn-xs btn-block' onclick='btnDeleteLoanApplicationDeductionOnclick()'><i class='fa fa-trash fa-fw'></i> Delete</button>";

                            var canPerformActions = "@ViewData["CanPerformActions"]";
                            if (canPerformActions == 1) {
                                if (isLocked) {
                                    btnEditButton = "<button class='btn btn-primary btn-xs btn-block' onclick='btnEditLoanApplicationDeductionOnclick()' disabled><i class='fa fa-edit fa-fw'></i> Edit</button>";
                                    btnDeleteButton = "<button class='btn btn-danger btn-xs btn-block' onclick='btnDeleteLoanApplicationDeductionOnclick()' disabled><i class='fa fa-trash fa-fw'></i> Delete</button>";
                                } else {
                                    btnEditButton = "<button class='btn btn-primary btn-xs btn-block' onclick='btnEditLoanApplicationDeductionOnclick()'><i class='fa fa-edit fa-fw'></i> Edit</button>";
                                    btnDeleteButton = "<button class='btn btn-danger btn-xs btn-block' onclick='btnDeleteLoanApplicationDeductionOnclick()'><i class='fa fa-trash fa-fw'></i> Delete</button>";
                                }
                            } else {
                                btnEditButton = "<button class='btn btn-primary btn-xs btn-block' onclick='btnEditLoanApplicationDeductionOnclick()' disabled><i class='fa fa-edit fa-fw'></i> Edit</button>";
                                btnDeleteButton = "<button class='btn btn-danger btn-xs btn-block' onclick='btnDeleteLoanApplicationDeductionOnclick()' disabled><i class='fa fa-trash fa-fw'></i> Delete</button>";
                            }

                            loanApplicationDeductionArray.push({
                                EditButton: btnEditButton,
                                DeleteButton: btnDeleteButton,
                                Id: loanApplicationDeductionResults[i]["Id"],
                                LoanId: loanApplicationDeductionResults[i]["LoanId"],
                                DeductionId: loanApplicationDeductionResults[i]["DeductionId"],
                                Deduction: loanApplicationDeductionResults[i]["Deduction"],
                                IsPercentage: loanApplicationDeductionResults[i]["IsPercentage"],
                                PercentageRate: loanApplicationDeductionResults[i]["PercentageRate"],
                                DeductionAmount: loanApplicationDeductionResults[i]["DeductionAmount"]
                            });

                            deductionAmount += loanApplicationDeductionResults[i]["DeductionAmount"];
                        }
                    }

                    document.getElementById("loanApplicationDeductionAmount").value = deductionAmount;
                    computeDeductions();

                    NProgress.done();
                }
            });

            return loanApplicationDeductionArray;
        }

        // edit loan application deduction
        function btnEditLoanApplicationDeductionOnclick() {
            $("#loanApplicationDeductionEditDetailModal").modal({
                "show": true,
                "backdrop": "static"
            });

            $('.requiredLoanApplicationDeduction').each(function () {
                $(this).css({
                    "border": "",
                });
            });

            document.getElementById("btnSaveLoanApplicationDeduction").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
            $("#btnSaveLoanApplicationDeduction").prop("disabled", false);
            $("#btnCloseLoanApplicationDeduction").prop("disabled", false);

            loanApplicationDeductionCollectionView.editItem(loanApplicationDeductionCollectionView.currentItem);
            var currentItem = loanApplicationDeductionCollectionView.currentEditItem;

            loanDeductionId = currentItem.Id;
            cboDeduction.selectedValue = currentItem.Deduction;
            document.getElementById("loanApplicationDeductionIsPercentage").checked = currentItem.IsPercentage;
            document.getElementById("loanApplicationDeductionPercentageRate").value = currentItem.PercentageRate;
            document.getElementById("loanApplicationDeductionDeductionAmount").value = currentItem.DeductionAmount;
        }

        // add loan application deduction
        function btnAddLoanApplicationDeductionOnclick() {
            $("#loanApplicationDeductionEditDetailModal").modal({
                "show": true,
                "backdrop": "static"
            });

            $('.requiredLoanApplicationDeduction').each(function () {
                $(this).css({
                    "border": "",
                });
            });

            document.getElementById("btnSaveLoanApplicationDeduction").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
            $("#btnSaveLoanApplicationDeduction").prop("disabled", false);
            $("#btnCloseLoanApplicationDeduction").prop("disabled", false);

            loanDeductionId = 0;
            getDeduction();
        }

        // form input validation
        function inputValidationForLoanApplicationDeduction() {
            var isValid = true;
            $('.requiredLoanApplicationDeduction').each(function () {
                if ($.trim($(this).val()) == '') {
                    isValid = false;
                    $(this).css({
                        "border": "1px solid red"
                    });
                } else {
                    $(this).css({
                        "border": "",
                    });
                }
            });

            return isValid;
        }

        // save loan deduction
        function btnSaveLoanApplicationDeductionOnclick() {
            if (inputValidationForLoanApplicationDeduction()) {
                document.getElementById("btnSaveLoanApplicationDeduction").innerHTML = "<i class='fa fa-spinner fa-spin fa-fw'></i> Saving";
                $("#btnSaveLoanApplicationDeduction").prop("disabled", true);
                $("#btnCloseLoanApplicationDeduction").prop("disabled", true);

                var loanApplicationDeductionObject = new Object();
                loanApplicationDeductionObject.LoanId = getUrlParameter("id");
                loanApplicationDeductionObject.DeductionId = cboDeduction.selectedItem["Id"];
                loanApplicationDeductionObject.DeductionAmount = document.getElementById('loanApplicationDeductionDeductionAmount').value;
                var loanApplicationDeductionData = JSON.stringify(loanApplicationDeductionObject);

                if (loanDeductionId == 0) {
                    $.ajax({
                        type: "POST",
                        url: '/api/loanDeductions/add',
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: loanApplicationDeductionData,
                        statusCode: {
                            200: function () {
                                toastr.success("Save Successful");

                                $("#loanApplicationDeductionEditDetailModal").modal("hide");

                                loanApplicationDeductionCollectionView = new wijmo.collections.CollectionView(getLoanApplicationDeductionByLoanId());
                                loanApplicationDeductionFlexGrid.itemsSource = loanApplicationDeductionCollectionView;
                                loanApplicationDeductionFlexGrid.trackChanges = true;
                            },
                            404: function () {
                                toastr.error("Record Not Found");

                                $("#loanApplicationDeductionEditDetailModal").modal("hide");

                                document.getElementById("btnSaveLoanApplicationDeduction").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
                                $("#btnSaveLoanApplicationDeduction").prop("disabled", false);
                                $("#btnCloseLoanApplicationDeduction").prop("disabled", false);
                            },
                            400: function () {
                                toastr.error("Bad Request");

                                $("#loanApplicationDeductionEditDetailModal").modal("hide");

                                document.getElementById("btnSaveLoanApplicationDeduction").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
                                $("#btnSaveLoanApplicationDeduction").prop("disabled", false);
                                $("#btnCloseLoanApplicationDeduction").prop("disabled", false);
                            }
                        }
                    });
                } else {
                    $.ajax({
                        type: "PUT",
                        url: '/api/loanDeductions/update/' + loanDeductionId,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: loanApplicationDeductionData,
                        statusCode: {
                            200: function () {
                                toastr.success("Update Successful");

                                $("#loanApplicationDeductionEditDetailModal").modal("hide");

                                loanApplicationDeductionCollectionView = new wijmo.collections.CollectionView(getLoanApplicationDeductionByLoanId());
                                loanApplicationDeductionFlexGrid.itemsSource = loanApplicationDeductionCollectionView;
                                loanApplicationDeductionFlexGrid.trackChanges = true;
                            },
                            404: function () {
                                toastr.error("Record Not Found");

                                $("#loanApplicationDeductionEditDetailModal").modal("hide");

                                document.getElementById("btnSaveLoanApplicationDeduction").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
                                $("#btnSaveLoanApplicationDeduction").prop("disabled", false);
                                $("#btnCloseLoanApplicationDeduction").prop("disabled", false);
                            },
                            400: function () {
                                toastr.error("Bad Request");

                                $("#loanApplicationDeductionEditDetailModal").modal("hide");

                                document.getElementById("btnSaveLoanApplicationDeduction").innerHTML = "<i class='fa fa-save fa-fw'></i> Save";
                                $("#btnSaveLoanApplicationDeduction").prop("disabled", false);
                                $("#btnCloseLoanApplicationDeduction").prop("disabled", false);
                            }
                        }
                    });
                }
            } else {
                toastr.error("Invalid Entry");
            }
        }

        // delete loan application deduction
        function btnDeleteLoanApplicationDeductionOnclick() {
            $("#deleteConfirmationLoanApplicationDeductionModal").modal({
                "show": true,
                "backdrop": "static"
            });

            document.getElementById("btnConfirmDeleteLoanApplicationDeduction").innerHTML = "Delete";
            $("#btnConfirmDeleteLoanApplicationDeduction").prop("disabled", false);
            $("#btnCloseDeleteLoanApplicationDeductionModal").prop("disabled", false);
        }
        function btnConfirmDeleteLoanApplicationDeductionOnclick() {
            document.getElementById("btnConfirmDeleteLoanApplicationDeduction").innerHTML = "<i class='fa fa-spinner fa-spin fa-fw'></i> Deleting";
            $("#btnConfirmDeleteLoanApplicationDeduction").prop("disabled", true);
            $("#btnCloseDeleteLoanApplicationDeductionModal").prop("disabled", true);

            loanApplicationDeductionCollectionView.editItem(loanApplicationDeductionCollectionView.currentItem);
            var currentItem = loanApplicationDeductionCollectionView.currentEditItem;

            $.ajax({
                type: "DELETE",
                url: '/api/loanDeductions/delete/' + currentItem.Id + '/' + getUrlParameter("id"),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                statusCode: {
                    200: function () {
                        toastr.success("Delete Successful");

                        $("#deleteConfirmationLoanApplicationDeductionModal").modal("hide");

                        loanApplicationDeductionCollectionView = new wijmo.collections.CollectionView(getLoanApplicationDeductionByLoanId());
                        loanApplicationDeductionFlexGrid.itemsSource = loanApplicationDeductionCollectionView;
                        loanApplicationDeductionFlexGrid.trackChanges = true;
                    },
                    404: function () {
                        toastr.error("Record Not Found");

                        $("#deleteConfirmationLoanApplicationDeductionModal").modal("hide");

                        document.getElementById("btnConfirmDeleteLoanApplicationDeduction").innerHTML = "Delete";
                        $("#btnConfirmDeleteLoanApplicationDeduction").prop("disabled", false);
                        $("#btnCloseDeleteLoanApplicationDeductionModal").prop("disabled", false);
                    },
                    400: function () {
                        toastr.error("Bad Request");

                        $("#deleteConfirmationLoanApplicationDeductionModal").modal("hide");

                        document.getElementById("btnConfirmDeleteLoanApplicationDeduction").innerHTML = "Delete";
                        $("#btnConfirmDeleteLoanApplicationDeduction").prop("disabled", false);
                        $("#btnCloseDeleteLoanApplicationDeductionModal").prop("disabled", false);
                    }
                }
            });
        }

        // create flexgrid for loan application deduction
        function createFlexGridForLoanApplicationDeduction() {
            loanApplicationDeductionCollectionView = new wijmo.collections.CollectionView(getLoanApplicationDeductionByLoanId());

            loanApplicationDeductionFlexGrid = new wijmo.grid.FlexGrid('#loanApplicationDeductionFlexGrid');
            loanApplicationDeductionFlexGrid.initialize({
                columns: [
                            {
                                "header": "Edit",
                                "binding": "EditButton",
                                "width": 80,
                                "align": "center",
                                "allowResizing": false,
                                "isContentHtml": true
                            },
                            {
                                "header": "Delete",
                                "binding": "DeleteButton",
                                "width": 80,
                                "align": "center",
                                "allowResizing": false,
                                "isContentHtml": true
                            },
                            {
                                "header": "Deduction",
                                "binding": "Deduction",
                                "allowSorting": true,
                                "width": "3*",
                            },
                            {
                                "header": "Is P",
                                "binding": "IsPercentage",
                                "allowSorting": true,
                                "width": "1*",
                            },
                            {
                                "header": "Rate",
                                "binding": "PercentageRate",
                                "allowSorting": true,
                                "width": "2*",
                            },
                            {
                                "header": "Amount",
                                "binding": "DeductionAmount",
                                "allowSorting": true,
                                "width": "2*",
                            }
                ],
                autoGenerateColumns: false,
                itemsSource: loanApplicationDeductionCollectionView,
                isReadOnly: true,
                autoSizeMode: wijmo.grid.AutoSizeMode.Both,
                allowDragging: wijmo.grid.AllowDragging.None,
                selectionMode: wijmo.grid.SelectionMode.Row
            });

            loanApplicationDeductionFlexGrid.trackChanges = true;
        }

        // penalty
        function getDeduction() {
            var deductionArray = new Array();
            $.ajax({
                url: '/api/deductions/list',
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                data: {},
                success: function (deductionResults) {
                    var disabled = true;
                    if (deductionResults.length > 0) {
                        for (i = 0; i < deductionResults.length; i++) {
                            deductionArray.push({
                                Id: deductionResults[i]["Id"],
                                Deduction: deductionResults[i]["Deduction"],
                                IsPercentage: deductionResults[i]["IsPercentage"],
                                PercentageRate: deductionResults[i]["PercentageRate"],
                                DeductionAmount: deductionResults[i]["DeductionAmount"],
                            });
                        }

                        disabled = false;
                    }

                    cboDeduction.dispose();
                    cboDeduction = new wijmo.input.ComboBox('#cboDeduction', {
                        disabled: disabled,
                        placeholder: "Select",
                        itemsSource: deductionArray,
                        isEditable: false,
                        required: true,
                        displayMemberPath: "Deduction",
                        selectedValuePath: "Deduction",
                        onSelectedIndexChanged: function () {
                            document.getElementById("loanApplicationDeductionIsPercentage").checked = this.selectedItem["IsPercentage"];
                            document.getElementById("loanApplicationDeductionPercentageRate").value = this.selectedItem["PercentageRate"];

                            if (this.selectedItem["IsPercentage"]) {
                                var principalAmountValue = document.getElementById('loanApplicationPrincipalAmount').value.replace(/\,/g, '');
                                var deductionAmount = (principalAmountValue / 100) * this.selectedItem["PercentageRate"];

                                document.getElementById("loanApplicationDeductionDeductionAmount").value = deductionAmount.toLocaleString();
                            } else {
                                document.getElementById("loanApplicationDeductionDeductionAmount").value = this.selectedItem["DeductionAmount"].toLocaleString();
                            }
                        }
                    });

                    document.getElementById("loanApplicationDeductionIsPercentage").checked = cboDeduction.selectedItem["IsPercentage"];
                    document.getElementById("loanApplicationDeductionPercentageRate").value = cboDeduction.selectedItem["PercentageRate"];

                    if (cboDeduction.selectedItem["IsPercentage"]) {
                        var principalAmountValue = document.getElementById('loanApplicationPrincipalAmount').value.replace(/\,/g, '');
                        var deductionAmount = (principalAmountValue / 100) * cboDeduction.selectedItem["PercentageRate"];

                        document.getElementById("loanApplicationDeductionDeductionAmount").value = deductionAmount.toLocaleString();
                    } else {
                        document.getElementById("loanApplicationDeductionDeductionAmount").value = cboDeduction.selectedItem["DeductionAmount"].toLocaleString();
                    }
                }
            });
        }

        // loan application tab
        $('#loanApplicationCollateralTab').click(function () {
            NProgress.start();
            $("#loanApplicationCollateral").show();
            $("#loanDeductions").hide();
            $("#loanLines").hide();
            $("#loanRenew").hide();

            createFlexGridForLoanApplicationCollateral();
            window.createFlexGridForLoanApplicationCollateral = function () {
                return true;
            }

            loanApplicationCollateralCollectionView = new wijmo.collections.CollectionView(getLoanApplicationCollateralByLoanId());
            loanApplicationCollateralFlexGrid.itemsSource = loanApplicationCollateralCollectionView;
            loanApplicationCollateralFlexGrid.trackChanges = true;
        });

        // tab
        $('#loanDeductionsTab').click(function () {
            NProgress.start();
            $("#loanApplicationCollateral").hide();
            $("#loanDeductions").show();
            $("#loanLines").hide();
            $("#loanRenew").hide();

            loanApplicationDeductionCollectionView = new wijmo.collections.CollectionView(getLoanApplicationDeductionByLoanId());
            loanApplicationDeductionFlexGrid.itemsSource = loanApplicationDeductionCollectionView;
            loanApplicationDeductionFlexGrid.trackChanges = true;
        });

        // loan lines
        function getLoanLinesListByLoanId() {
            var loanLinesArray = new wijmo.collections.ObservableArray;
            $.ajax({
                url: '/api/loanLines/listByLoanId/' + getUrlParameter("id"),
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                success: function (loanLinesResults) {
                    if (loanLinesResults.length > 0) {
                        for (i = 0; i < loanLinesResults.length; i++) {

                            var newDate = new Date(loanLinesResults[i]["CollectibleDate"]);
                            var collectibleDate = ('0' + (newDate.getMonth() + 1)).slice(-2) + '-' + ('0' + newDate.getDate()).slice(-2) + '-' + newDate.getFullYear();

                            loanLinesArray.push({
                                Id: loanLinesResults[i]["Id"],
                                DayReference: loanLinesResults[i]["DayReference"],
                                CollectibleDate: collectibleDate,
                                CollectibleAmount: loanLinesResults[i]["CollectibleAmount"],
                                PaidAmount: loanLinesResults[i]["PaidAmount"],
                                PenaltyAmount: loanLinesResults[i]["PenaltyAmount"],
                                IsCleared: loanLinesResults[i]["IsCleared"]
                            });
                        }
                    }

                    NProgress.done();
                }
            });

            return loanLinesArray;
        }

        var loanLinesCollectionView;
        var loanLinesFlexgrid;

        // create flexgrid for loan application lines
        function createFlexGridForLoanLines() {
            loanLinesCollectionView = new wijmo.collections.CollectionView(getLoanLinesListByLoanId());

            loanLinesFlexgrid = new wijmo.grid.FlexGrid('#loanLinesFlexgrid');
            loanLinesFlexgrid.initialize({
                columns: [
                            {
                                "header": "Day Reference",
                                "binding": "DayReference",
                                "allowSorting": true,
                                "width": "4.5*",
                            },
                            {
                                "header": "Collectible Date",
                                "binding": "CollectibleDate",
                                "allowSorting": true,
                                "width": "2.3*",
                            },
                            {
                                "header": "Collectible",
                                "binding": "CollectibleAmount",
                                "allowSorting": true,
                                "width": "2*",
                            },
                            {
                                "header": "Penalty",
                                "binding": "PenaltyAmount",
                                "allowSorting": true,
                                "width": "2*",
                            },
                            {
                                "header": "Paid",
                                "binding": "PaidAmount",
                                "allowSorting": true,
                                "width": "2*",
                            },
                            {
                                "header": "C",
                                "binding": "IsCleared",
                                "allowSorting": true,
                                "width": "1*",
                            },
                ],
                autoGenerateColumns: false,
                itemsSource: loanLinesCollectionView,
                isReadOnly: true,
                autoSizeMode: wijmo.grid.AutoSizeMode.Both,
                allowDragging: wijmo.grid.AllowDragging.None,
                selectionMode: wijmo.grid.SelectionMode.Row
            });

            loanLinesFlexgrid.trackChanges = true;
        }

        // tab
        $('#loanLinesTab').click(function () {
            NProgress.start();
            $("#loanApplicationCollateral").hide();
            $("#loanDeductions").hide();
            $("#loanLines").show();
            $("#loanRenew").hide();

            createFlexGridForLoanLines();
            window.createFlexGridForLoanLines = function () {
                return true;
            }

            loanLinesCollectionView = new wijmo.collections.CollectionView(getLoanLinesListByLoanId());
            loanLinesFlexgrid.itemsSource = loanLinesCollectionView;
            loanLinesFlexgrid.trackChanges = true;
        });

        var loanRenewCollectionView;
        var loanRenewFlexgrid;

        // loan lines
        function getLoanRenew() {
            var loanRenews = new wijmo.collections.ObservableArray;
            $.ajax({
                url: '/api/loanRenew/list/ByLoanId/' + getUrlParameter("id"),
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                success: function (loanRenewsResults) {
                    if (loanRenewsResults.length > 0) {
                        var btnLoanNumber = "<button class='btn btn-primary btn-xs btn-block' onclick='btnLoanNumberOnclick()'><i class='fa fa-file-text-o fa-fw'></i> Loan App</button>";

                        for (i = 0; i < loanRenewsResults.length; i++) {
                            var loanNumberRenewed = loanRenewsResults[i]["RenewLoanNumber"];
                            if (loanRenewsResults[i]["IsLoanApplication"]) {
                                loanNumberRenewed = "LN - " + loanRenewsResults[i]["RenewLoanNumber"];
                            } else {
                                if (loanRenewsResults[i]["IsLoanRenew"]) {
                                    loanNumberRenewed = "RC - " + loanRenewsResults[i]["RenewLoanNumber"];
                                } else {
                                    if (loanRenewsResults[i]["IsLoanRenew"]) {
                                        loanNumberRenewed = "RN - " + loanRenewsResults[i]["RenewLoanNumber"];
                                    }
                                }
                            }

                            loanRenews.push({
                                Id: loanRenewsResults[i]["Id"],
                                BtnLoanNumber: btnLoanNumber,
                                LoanId: loanRenewsResults[i]["DayReference"],
                                RenewLoanId: loanRenewsResults[i]["RenewLoanId"],
                                RenewLoanNumber: loanNumberRenewed,
                                RenewPrincipalAmount: loanRenewsResults[i]["RenewPrincipalAmount"],
                                RenewLoanTotalBalanceAmount: loanRenewsResults[i]["RenewLoanTotalBalanceAmount"],
                                RenewLoanTotalPenaltyAmount: loanRenewsResults[i]["RenewLoanTotalPenaltyAmount"],
                                IsLoanApplication: loanRenewsResults[i]["IsLoanApplication"],
                                IsLoanRenew: loanRenewsResults[i]["IsLoanRenew"],
                                IsLoanRenew: loanRenewsResults[i]["IsLoanRenew"],
                            });
                        }
                    }

                    NProgress.done();
                }
            });

            return loanRenews;
        }

        // create flexgrid for loan application renew
        function createFlexGridForLoanRenew() {
            loanRenewCollectionView = new wijmo.collections.CollectionView(getLoanRenew());

            loanRenewFlexgrid = new wijmo.grid.FlexGrid('#loanRenewFlexgrid');
            loanRenewFlexgrid.initialize({
                columns: [
                            {
                                "header": "Loan App",
                                "binding": "BtnLoanNumber",
                                "width": "1*",
                                "align": "center",
                                "allowResizing": false,
                                "isContentHtml": true
                            },
                            {
                                "header": "Renew Loan Number",
                                "binding": "RenewLoanNumber",
                                "allowSorting": true,
                                "width": "2*",
                            },
                            {
                                "header": "Renew Amount",
                                "binding": "RenewPrincipalAmount",
                                "allowSorting": true,
                                "width": "2*",
                            },
                            {
                                "header": "Balance Amount",
                                "binding": "RenewLoanTotalBalanceAmount",
                                "allowSorting": true,
                                "width": "2*",
                            },
                            {
                                "header": "Penalty Amount",
                                "binding": "RenewLoanTotalPenaltyAmount",
                                "allowSorting": true,
                                "width": "2*",
                            },
                ],
                autoGenerateColumns: false,
                itemsSource: loanRenewCollectionView,
                isReadOnly: true,
                autoSizeMode: wijmo.grid.AutoSizeMode.Both,
                allowDragging: wijmo.grid.AllowDragging.None,
                selectionMode: wijmo.grid.SelectionMode.Row
            });

            loanRenewFlexgrid.trackChanges = true;
        }

        // loan app
        function btnLoanNumberOnclick() {
            loanRenewCollectionView.editItem(loanRenewCollectionView.currentItem);
            var currentItem = loanRenewCollectionView.currentEditItem;

            if (currentItem.IsLoanApplication) {
                window.location = '/Software/LoanApplicationDetail?id=' + currentItem.RenewLoanId;
            } else {
                if (currentItem.IsLoanRenew) {
                    window.location = '/Software/RenewDetail?id=' + currentItem.RenewLoanId;
                } else {
                    if (currentItem.IsLoanRenew) {
                        window.location = '/Software/RenewDetail?id=' + currentItem.RenewLoanId;
                    } else {
                        window.location = '/Software/LoanApplicationDetail?id=' + currentItem.RenewLoanId;
                    }
                }
            }
        }

        // tab
        $('#loanRenewTab').click(function () {
            NProgress.start();
            $("#loanApplicationCollateral").hide();
            $("#loanDeductions").hide();
            $("#loanLines").hide();
            $("#loanRenew").show();

            createFlexGridForLoanRenew();
            window.createFlexGridForLoanRenew = function () {
                return true;
            }

            loanRenewCollectionView = new wijmo.collections.CollectionView(getLoanRenew());
            loanRenewFlexgrid.itemsSource = loanRenewCollectionView;
            loanRenewFlexgrid.trackChanges = true;
        });

        // on load page
        window.onload = function () {
            NProgress.start();
            toastrModification();
            loanApplicationLoanDateRange();

            $(document).on('show.bs.modal', '.modal', function (event) {
                var zIndex = 1040 + (10 * $('.modal:visible').length);
                $(this).css('z-index', zIndex);
                setTimeout(function () {
                    $('.modal-backdrop').not('.modal-stack').css('z-index', zIndex - 1).addClass('modal-stack');
                }, 0);
            });

            $(document).on('hidden.bs.modal', '.modal', function () {
                $('.modal:visible').length && $(document.body).addClass('modal-open');
            });

            var canPerformActions = "@ViewData["CanPerformActions"]";
            if (canPerformActions == 1) {
                $('#btnClose').prop('disabled', false);
            } else {
                $(':button').prop('disabled', true);
                $('#btnClose').prop('disabled', false);
                getUserRightsMessageError();
            }

            cboDeduction = new wijmo.input.ComboBox('#cboDeduction');
            getDeduction();
        }

        // compute deductions to net amount
        function computeDeductions() {
            var principalAmountValue = document.getElementById('loanApplicationPrincipalAmount').value.replace(/\,/g, '');
            var interestRate = document.getElementById('interestRate').value.replace(/\,/g, '');
            var interestAmount = (principalAmountValue / 100) * interestRate;
            document.getElementById('interestAmount').value = interestAmount.toLocaleString();
            var interestAmountValue = document.getElementById('interestAmount').value.replace(/\,/g, '');

            // deductions
            var deductionAmountValue = document.getElementById('loanApplicationDeductionAmount').value.replace(/\,/g, '');
            var previousPenaltyAmount = document.getElementById('previousPenaltyAmount').value.replace(/\,/g, '');
            var previousBalanceAmount = document.getElementById('previousBalanceAmount').value.replace(/\,/g, '');

            var totalDeductions = parseFloat(previousBalanceAmount) + parseFloat(previousPenaltyAmount) + parseFloat(deductionAmountValue);

            var netAmount = parseFloat(principalAmountValue) - parseFloat(totalDeductions);
            var netCollectionAmount = parseFloat(principalAmountValue) + parseFloat(interestAmountValue);

            document.getElementById('loanApplicationTotalNetAmount').value = netAmount.toLocaleString();
            document.getElementById('loanApplicationTotalNetCollectionAmount').value = netCollectionAmount.toLocaleString();
        }

        // jqueries codes
        $('#loanApplicationPrincipalAmount').keyup(function () {
            computeDeductions();
        });

        // print cash voucher
        function btnCashVoucherOnClick() {
            if (isLocked) {
                window.open("/RepCashVoucherPDF/CashVoucherPDF?loanId=" + getUrlParameter("id"), "_blank");
            } else {
                toastr.error("Not Locked");
            }
        }

        // print collectibles
        function btnCollectiblesOnClick() {
            if (isLocked) {
                window.open("/RepCollectiblesPDF/Collectibles?loanId=" + getUrlParameter("id"), "_blank");
            } else {
                toastr.error("Not Locked");
            }
        }
    </script>
</body>
</html>